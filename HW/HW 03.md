# HW 03
### anti-disassembly


## Lab 15-01.exe
1.
它在jz指令之後插入rogue opcodes。由於cmp的計算結果ZF=0，故不會執行xor 和JZ 指令，但 IDA 仍會進行反組譯。

![](https://i.imgur.com/pXmBk2a.png)

將E8改為data，使反組譯的結果正常。

![](https://i.imgur.com/cporx3v.png)

2.
E8 為用來欺騙反組譯程式的rogue opcodes。

![](https://i.imgur.com/e0zuhGo.png)

3.
共5次，分別位在0x00401010、0x00401023、0x00401037、0x0040104B、0x00401062。

![](https://i.imgur.com/1qF6g2p.png)

4.
`pdq`可使程式print：Good Job!。

![](https://i.imgur.com/CIKE0Sg.png)

![](https://i.imgur.com/SLbkAwi.png)


## Lab 15-02.exe
1.
首先透過ida pro 將rogue opcodes 與 dual opcodes 改為 nop 指令，使其能正確反組譯。

![](https://i.imgur.com/02g0Jxy.png)

![](https://i.imgur.com/TXxuS7b.png)

![](https://i.imgur.com/GZv4RyG.png)

![](https://i.imgur.com/KypDZtm.png)

![](https://i.imgur.com/aVrzLrj.png)

找到 InternetOpenURL，可以得知URL為：http://www.practicalmalwareanalysis.com/bamboo.html

![](https://i.imgur.com/j2Qaovc.png)

2.
通過修改 GetHostName return 的 strings。

![](https://i.imgur.com/DTJ5QOB.png)

3.
Bamboo::

![](https://i.imgur.com/ByRo7d4.png)
4.
它會提取一個 url 並通過 InternetOpenUrlA 和 InternetReadFile 下載其內容，然後保存在Account Sumamry.xls.exe下，最後透過ShellExecuteA執行。

![](https://i.imgur.com/Da0GEhG.png)

![](https://i.imgur.com/VNsqDic.png)


## Lab 16-01.exe


1.
它會檢查BeingDebugged、ForceFlag 和 NtGlobalFlag。

![](https://i.imgur.com/31IMIuU.png)

2.
它會刪除程式本身。
![](https://i.imgur.com/c2VCoIp.png)


3.
將je 改成 jne 、 jnz 改成 jz，或是將判斷式改為nop，使其不會跳出程式而中斷。

4.
將中斷點設在`MOV EAX,DWORD PTR FS:`，EAX被設為 0x00215000，即 PEB 的位址。故0x00215002 即包含 BeingDebugged ，便可透過 bump 將其改為零。

![](https://i.imgur.com/VrxJZFB.png)

![](https://i.imgur.com/UkLthJx.png)

5.
PhantOm plugin。

## Lab 16-02.exe
1.
![](https://i.imgur.com/B8wcxQ4.png)
2.
![](https://i.imgur.com/IH2F27s.png)
3.
使用ida pro 分析，得知程式最後會透過 0x40123A 的 strncmp 判斷輸入的string。

![](https://i.imgur.com/FWPRMsI.png)

使用x32dbg 修改0x4011ED 的值，使程式可以往下執行。

![](https://i.imgur.com/kNDXJIu.png)

將 OutputDebugString的檢查改為nop，並在執行時將 BeingDebugged Flag改為0。 

![](https://i.imgur.com/2EHXV84.png)

![](https://i.imgur.com/6bNBQn4.png)

![](https://i.imgur.com/zrV3TvM.png)

往下執行程式，發現0x00408030儲存的string 為bzrrp@ss。

![](https://i.imgur.com/w6oHTk3.png)

而程式中的strncmp只會判斷其中前四個char

![](https://i.imgur.com/id6802z.png)

故密碼為`bzrr`。
![](https://i.imgur.com/dRhh2QR.png)

4.
strncmp 在 0x40123A。

![](https://i.imgur.com/FWPRMsI.png)

5.

程式會自動終止。

6.
此式包含.tls。
![](https://i.imgur.com/YhSRDnR.png)

7.
在0x00401060。

![](https://i.imgur.com/AavzJYx.png)

8.
透過 FindWindowA 檢查是否有OLLYDBG 、OutputDebugString、BeingDebugged flag。

9.
bzrrp@ss。

![](https://i.imgur.com/w6oHTk3.png)

10.
無效，因程式中的strncmp只會判斷其中前四個char。

11.

將 OutputDebugString 改為nop，執行時將 BeingDebuggedFlag 設為0。










###### tags: `malware`
