# LAB 01


## 1.
### 1.1

使用IDA pro 分析程式，檢查 WinMain()。
其首先會判斷是否能與`http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com` 連接，若可以則 return 0 並終止程式，若無法連接則呼叫位於 408090 的函式繼續執行。

killswitch 即攻擊者虛構一個不存在的 doamin，若對其發起 request 卻得到response，wannacry會判定自己正被分析，不執行惡意行為，以此功能達到防禦分析的效果。

<br>

### 1.2

繼續檢查位於 408090 的函式，發現其呼叫位在 407CE0 的函式，使用`FindResourceA(0, (LPCSTR)0x727, Type)` 取得ID 1831 的 resource，並創建taskche.exe，再將 resource 寫入。

![](https://i.imgur.com/ITWTEPE.png)

使用CTF Explorer 取得resource，並使用IDA pro 分析。

![](https://i.imgur.com/XymCqWr.png)

檢查 WinMain()，程式會先產生隨機數，並加密檔案。接著呼叫位在 401DAB的函式，傳入兩個參數(0,char WNcry@2ol7)，並讀取resource。

使用CTF Explorer 取得ID 2058 的 resource。

![](https://i.imgur.com/EvtKrTB.png)

嘗試對XIA檔進行解壓縮，推測其密碼為：**WNcry@2ol7**

![](https://i.imgur.com/wt626uR.png)

<br>

## 2.

嘗試執行程式，得到輸出 `Invalid serial number!`。
使用IDA pro 分析，找到輸出的判斷函式：

![](https://i.imgur.com/EOZwXWg.png)

反編譯後找到得到另一個輸出的條件，其函式位於 401000：

![](https://i.imgur.com/Zq6CCb4.png)

檢查401000的函式：

![](https://i.imgur.com/sxaenY9.png)

得到答案：**NOREPLS-U89S-N34J-3IOJ-989Y**

![](https://i.imgur.com/jEyi4IS.png)

<br>

## 3.

使用x32dgb，從entry point開始檢查，發現位在401500 的函式可以輸出flag：flag{M3x1c4nMl4lw4r3_pl3rro}。

找到呼叫此函式的指令位址：40164C。

![](https://i.imgur.com/Bsm2YDe.png)

檢查其前面的指令，得知在`cmp dword ptr ss:[esp+1C],C1` 比較 [esp+1C] 與 0xC1時，若[esp+1C]之值 $\le$ 0xC1，則 40164C 的指令會被跳過。

故修改 401642 的指令，將 0xC1 改為0x0，使得[esp+1C]之值>0x0成立。

![](https://i.imgur.com/ev9Vb6S.png)

執行程式，其print：**flag{M3x1c4nMl4lw4r3_pl3rro}**。

![](https://i.imgur.com/wmYdnk5.png)

